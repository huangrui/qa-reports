- if (@files != nil && @files.length > 0) || @editing
  h2#attachments Attachments

  ul#file_attachment_list class="item_list attachment #{'editing' if @editing}"
    span#file_attachment_list_ready
        = render :partial => "reports/file_attachment_list", :locals => {:report => @report, :files => @files || []}

  - if @editing
    / TODO: make uploads use plain JS instead of flash
    .uploadify_button_wrapper
      a#upload_button.small_btn + Add attachment
      .uploadify_object_wrapper
        input#file_upload name="attachment" style="display:none;" type="file"

    - session_key = Rails.application.config.session_options[:key]
    javascript:
      $(document).ready(function() {
        var uploadify_script_data = {};
        var csrf_token = encodeURIComponent(encodeURIComponent($('meta[name=csrf-token]').attr('content')));
        var csrf_param = $('meta[name=csrf-param]').attr('content');
        uploadify_script_data[csrf_param] = csrf_token;
        // TODO: can this be made cleaner?
        uploadify_script_data['#{session_key}'] = encodeURIComponent(encodeURIComponent('#{u cookies[session_key]}'));
        uploadify_script_data['id'] = #{@test_session.id};
        $('#file_upload').uploadify({
            'uploader'   : '/javascripts/uploadify/uploadify.swf',
            'script'     : '/upload_attachment/',
            'auto'       : true,
            'cancelImg'  : '/javascripts/uploadify/cancel.png',
            'wmode'      : 'transparent',
            'buttonImage': ' ',
            'hideButton' : true,
            'scriptData' : uploadify_script_data,
            'onProgress' : function(event, queueId, fileObj, data) {
                $('#file_upload' + queueId + 'ProgressBar').text(data.percentage+"%");
                return false;
            },
            'onSelect'  : function(event, queueId, fileObj) {
                $("#file_attachment_list").append($('<li id="file_upload'+queueId+'"><a href="javascript:$(\'#file_upload\').uploadifyCancel(\'' + queueId + '\')" class="remove_list_item">Remove</a>'+fileObj.name+'  <img src="/images/progress.gif" /> <span id="file_upload' + queueId + 'ProgressBar"></span></li>'));
                return false;
            },
            'onComplete': function(event, queueId, fileObj, response, data) {
                $("#file_attachment_list_ready").html(response);
            }
        });    
        // From http://stackoverflow.com/questions/2483662/uploadify-button-style-with-css
        var $buttonWrapper = $(".uploadify_button_wrapper");
        var $objectWrapper = $(".uploadify_object_wrapper");
        var $object = $("object", $objectWrapper);
        var $fakeButton = $("#upload_button");
        var width = $fakeButton.outerWidth();
        var height = $fakeButton.outerHeight();
        $object.attr("width", width).attr("height", height);
        $buttonWrapper.css("width", width + "px").css("height", height + "px")
        $objectWrapper.hover(function() {
            $fakeButton.addClass("hover");
        }, function() {
            $fakeButton.removeClass("hover");
        });
      });
            
